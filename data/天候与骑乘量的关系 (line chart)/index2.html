<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Colored Background Line Chart</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <svg id="chart"></svg>
    <div id="legend"></div>

    <script>
        // Specify SVG dimensions
        const margin = { top: 50, right: 50, bottom: 50, left: 100 };
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // Create SVG element
        const svg = d3.select("#chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Select element to display additional information
        const legend = d3.select("#legend");

        // Load data
        d3.csv("climate.csv").then(data => {
            data.forEach(d => {
                // Process dates in the format YYYYMM
                const year = parseInt(d.date / 100);
                const month = d.date % 100;
                d.date = new Date(year, month - 1); // Create JavaScript Date object
                d.rainyDays = +d.rainyDays;
                d.bikeUsage = +d.bikeUsage;
            });

            // Calculate maximum rainy days
            const maxRainyDays = d3.max(data, d => d.rainyDays);

            // Define X scale
            const xScale = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            // Define Y scale (bikeUsage)
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.bikeUsage)])
                .range([height, 0]);

            // Create X axis
            const xAxis = d3.axisBottom(xScale)
                .tickFormat(d3.timeFormat("%Y-%m")); // Specify date format
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            // Create Y axis
            const yAxis = d3.axisLeft(yScale);
            svg.append("g")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "-3em")
                .style("text-anchor", "end")
                .text("Bike Usage");

            // Create background for rainy days
            const months = d3.timeMonths(xScale.domain()[0], xScale.domain()[1]); // Group data by month
            svg.selectAll(".month-background")
                .data(months)
                .enter().append("rect")
                .attr("class", "month-background")
                .attr("x", d => xScale(d))
                .attr("y", 0)
                .attr("width", d => xScale(d3.timeMonth.offset(d, 1)) - xScale(d))
                .attr("height", height)
                .style("fill", d => {
                    const monthData = data.find(item => item.date.getMonth() === d.getMonth());
                    return monthData && monthData.rainyDays > 10 ? "lightblue" : "none"; // Set background color for rainy days
                });

            // Create Bike Usage line
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(d => xScale(d.date))
                    .y(d => yScale(d.bikeUsage))
                );

            // Add additional information
            legend.append("p").text("Additional Information:");
            legend.append("p").text("- Colored months indicate more than 10 rainy days.");
        });
    </script>
</body>
</html>
